import React, { useState, useEffect } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import { useNavigate, Link } from 'react-router-dom';
import { ArrowLeft, ShoppingBag, Pencil, ArrowSquareOut, X, Tag, NumberCircleOne, NumberCircleTwo, NumberCircleThree, ArrowUpRight, Info, Warning, Plus, Minus, CaretDown } from '@phosphor-icons/react';
import CheckoutSteps from './components/CheckoutSteps';
import ContactLocationForm from './components/ContactLocationForm';
import PaymentShippingForm from './components/PaymentForm';
import RecapForm from './components/RecapForm';
import OrderConfirmation from './components/OrderConfirmation';
import { products, formatPrice } from '../../data/products';
import './checkout.scss';

// Create mock cart items using real products
const mockCartItems = [
  {
    id: products[0].variants[0].id,
    name: products[0].name,
    price: products[0].variants[0].price,
    quantity: 1,
    image: products[0].variants[0].image,
    variant: products[0].variants[0].size,
    productId: products[0].id // Add productId for linking to product page
  },
  {
    id: products[2].variants[1].id,
    name: products[2].name,
    price: products[2].variants[1].price,
    quantity: 2,
    image: products[2].variants[1].image,
    variant: products[2].variants[1].size,
    productId: products[2].id // Add productId for linking to product page
  }
];

const Checkout = () => {
  const [currentStep, setCurrentStep] = useState(0);
  const [isMobile, setIsMobile] = useState(window.innerWidth <= 992);
  // Use mock cart instead of redux state for demo
  const [cart, setCart] = useState({
    items: mockCartItems
  });
  const [isItemsListVisible, setIsItemsListVisible] = useState(true);
  const [isTotalsVisible, setIsTotalsVisible] = useState(true);
  const navigate = useNavigate();
  const dispatch = useDispatch();

  // Format with MAD currency
  const formatMAD = (value) => formatPrice(value, 'MAD');

  // Handle window resize for responsive layout
  useEffect(() => {
    const handleResize = () => {
      setIsMobile(window.innerWidth <= 992);
    };

    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // Form data state
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    address: '',
    city: '',
    country: '',
    differentShipping: false,
    shippingAddress: '',
    shippingMethod: 'free',
    paymentMethod: 'cashOnDelivery',
  });

  // Calculate shipping cost and tax
  const getShippingCost = () => {
    switch(formData.shippingMethod) {
      case 'express': return 15.00;
      case 'premium': return 48.00;
      case 'free':
      default: return 0.00;
    }
  };

  const shippingCost = getShippingCost();
  const subtotal = cart.items.reduce((acc, item) => acc + (item.price * item.quantity), 0);
  const tax = subtotal * 0.1; // 10% tax
  const total = subtotal + shippingCost + tax;

  // Handle form input changes
  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData({
      ...formData,
      [name]: type === 'checkbox' ? checked : value,
    });
  };

  // Step navigation functions
  const nextStep = () => {
    window.scrollTo(0, 0);
    setCurrentStep(currentStep + 1);
  };

  const prevStep = () => {
    if (currentStep === 0) {
      // Go back to cart page
      navigate('/cart');
    } else {
      setCurrentStep(currentStep - 1);
      window.scrollTo(0, 0);
    }
  };

  // Handle order placement
  const placeOrder = () => {
    // Here you would submit the order to your backend
    // For now we'll just simulate by generating an order number
    const orderNumber = `ORD-${Math.floor(Math.random() * 10000000)}`;

    // Move to the confirmation step
    window.scrollTo(0, 0);
    setCurrentStep(3);
  };

  // Handle item edit button click
  const handleEditItem = (itemId) => {
    console.log(`Edit item ${itemId}`);
    // Here you would implement the edit functionality
  };

  // Render current step content
  const renderStepContent = () => {
    switch (currentStep) {
      case 0: // Contact & Location
        return <ContactLocationForm formData={formData} handleChange={handleChange} nextStep={nextStep} prevStep={prevStep} />;
      case 1: // Payment & Shipping
        return <PaymentShippingForm formData={formData} handleChange={handleChange} nextStep={nextStep} prevStep={prevStep} />;
      case 2: // Recap
        return (
          <RecapForm
            formData={formData}
            cart={cart}
            shippingCost={shippingCost}
            tax={tax}
            placeOrder={placeOrder}
            prevStep={prevStep}
          />
        );
      case 3: // Confirmation
        return (
          <OrderConfirmation
            orderNumber={`ORD-${Math.floor(Math.random() * 10000000)}`}
            orderDate={new Date()}
            formData={formData}
            cart={cart}
            shippingCost={shippingCost}
            tax={tax}
            total={total}
            email={formData.email}
          />
        );
      default:
        return <ContactLocationForm formData={formData} handleChange={handleChange} nextStep={nextStep} prevStep={prevStep} />;
    }
  };

  // Add these functions for handling quantity changes
  const increaseQuantity = (itemId) => {
    const updatedItems = cart.items.map(item => {
      if (item.id === itemId) {
        return { ...item, quantity: item.quantity + 1 };
      }
      return item;
    });

    setCart({ items: updatedItems });
    // Recalculate totals will happen automatically on re-render
  };

  const decreaseQuantity = (itemId) => {
    const updatedItems = cart.items.map(item => {
      if (item.id === itemId && item.quantity > 1) {
        return { ...item, quantity: item.quantity - 1 };
      }
      return item;
    });

    setCart({ items: updatedItems });
    // Recalculate totals will happen automatically on re-render
  };

  // Toggle visibility of cart items list
  const toggleItemsList = () => {
    setIsItemsListVisible(!isItemsListVisible);
  };

  // Toggle visibility of totals section
  const toggleTotals = () => {
    setIsTotalsVisible(!isTotalsVisible);
  };

  // Inline styles for collapsible components
  const summaryHeaderStyle = {
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    padding: '1rem',
    background: 'linear-gradient(135deg, rgba(255, 253, 235, 0.9), rgba(235, 235, 71, 0.2))',
    borderBottom: isItemsListVisible ? '1px solid rgba(170, 204, 0, 0.2)' : 'none',
    cursor: 'pointer',
  };

  const totalsHeaderStyle = {
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    padding: '1rem',
    background: 'linear-gradient(135deg, rgba(255, 253, 235, 0.9), rgba(235, 235, 71, 0.2))',
    borderTop: '1px solid rgba(170, 204, 0, 0.2)',
    borderBottom: isTotalsVisible ? 'none' : '1px solid rgba(170, 204, 0, 0.2)',
    cursor: 'pointer',
  };

  const toggleIconStyle = (isVisible) => ({
    transform: isVisible ? 'rotate(180deg)' : 'rotate(0deg)',
    transition: 'transform 0.3s ease',
    color: '#0A5C26',
  });

  const cartFooterStyle = {
    padding: '0.75rem',
    textAlign: 'center',
    color: 'var(--dark-green-6)',
    fontSize: '0.9rem',
    fontWeight: '500',
    backgroundColor: 'rgba(255, 251, 230, 0.5)',
    borderTop: '1px solid rgba(170, 204, 0, 0.2)',
  };

  return (
    <div className="checkout-page">
      <div className="page-container">
        {currentStep < 3 && (
          <div className="checkout-header">
            <button
              className={`back-button ${currentStep === 0 ? 'disabled' : ''}`}
              onClick={prevStep}
              disabled={currentStep === 0}
              aria-label={currentStep === 0 ? "Retour (désactivé sur la première étape)" : "Retour à l'étape précédente"}
            >
              <ArrowLeft size={20} weight="duotone" />
            </button>
            <div className="steps-container">
              <CheckoutSteps currentStep={currentStep} />
            </div>
          </div>
        )}

        {currentStep < 3 ? (
          <div className="checkout-content">
            <div className="checkout-main">
              <div className="checkout-section">
                {renderStepContent()}
              </div>
            </div>
            <div className="checkout-sidebar">
              <div className="sidebar-content">
                <div className="cart-summary">
                  <div
                    style={summaryHeaderStyle}
                    onClick={toggleItemsList}
                  >
                    <ShoppingBag size={20} weight="duotone" />
                    <h3 style={{ flex: 1, margin: 0 }}>Votre Commande</h3>
                    <CaretDown
                      size={16}
                      style={toggleIconStyle(isItemsListVisible)}
                    />
                  </div>

                  {isItemsListVisible && (
                    <div className="cart-items-list">
                      {cart.items.map((item, index) => (
                        <div className="cart-item" key={index}>
                          <div className="item-image">
                            <img src={item.image} alt={item.name} />
                          </div>
                          <div className="item-content">
                            <div className="item-title">
                              <h4>{item.name}</h4>
                              {item.variant && <div className="item-variant">{item.variant}</div>}
                            </div>
                            <div className="item-actions">
                              <div className="item-price">
                                {formatMAD(item.price)}
                              </div>
                              <div className="quantity-controls">
                                <button
                                  className="quantity-btn minus"
                                  onClick={() => decreaseQuantity(item.id)}
                                  disabled={item.quantity <= 1}
                                >
                                  <Minus size={16} weight="bold" />
                                </button>
                                <span className="quantity">{item.quantity}</span>
                                <button
                                  className="quantity-btn plus"
                                  onClick={() => increaseQuantity(item.id)}
                                >
                                  <Plus size={16} weight="bold" />
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                      <div style={cartFooterStyle}>
                        <span>Total: {cart.items.reduce((acc, item) => acc + item.quantity, 0)} articles</span>
                      </div>
                    </div>
                  )}

                  <div
                    style={totalsHeaderStyle}
                    onClick={toggleTotals}
                  >
                    <h3 style={{ flex: 1, margin: 0 }}>Résumé</h3>
                    <CaretDown
                      size={16}
                      style={toggleIconStyle(isTotalsVisible)}
                    />
                  </div>

                  {isTotalsVisible && (
                    <div className="summary-totals">
                      <div className="summary-row">
                        <span>Sous-total</span>
                        <span>{formatMAD(subtotal)}</span>
                      </div>
                      <div className="summary-row">
                        <span>Frais de livraison</span>
                        <span>{formatMAD(shippingCost)}</span>
                      </div>
                      <div className="shipping-notice">
                        <Info size={14} weight="duotone" />
                        Les frais de livraison seront calculés en fonction du mode de livraison choisi à l'étape suivante.
                      </div>
                      <div className="summary-row">
                        <span>Taxes</span>
                        <span>{formatMAD(tax)}</span>
                      </div>
                      <div className="summary-row total">
                        <span>Total</span>
                        <span>{formatMAD(total)}</span>
                      </div>
                      <div className="shipping-notice">
                        <Warning size={14} weight="duotone" />
                        Ce montant est estimatif et pourra changer en fonction des options choisies ultérieurement.
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div className="checkout-content confirmation">
            {renderStepContent()}
          </div>
        )}
      </div>
    </div>
  );
};

export default Checkout;